steps:
  - label: ":hammer: Verify BuildKit certificates"
    command: |
      set -euo pipefail
      
      # Verify certificates were installed by bootstrap hook
      BUILDKIT_DIR="${HOME}/.buildkit"
      if [ ! -f "${BUILDKIT_DIR}/ca.crt" ] || [ ! -f "${BUILDKIT_DIR}/client.crt" ] || [ ! -f "${BUILDKIT_DIR}/client.key" ]; then
        echo "❌ BuildKit certificates not found. Bootstrap hook may have failed."
        exit 1
      fi
      
      echo "✅ BuildKit certificates installed successfully"
      ls -la "${BUILDKIT_DIR}/"
      
      # Verify environment variables are set
      echo "BUILDKIT_HOST=${BUILDKIT_HOST}"
      echo "BUILDKIT_TLS_CERT=${BUILDKIT_TLS_CERT}"

  - label: ":docker: Test BuildKit connectivity"
    depends_on: "step-0"
    command: |
      set -euo pipefail
      
      echo "Testing connectivity to BuildKit daemon at $${BUILDKIT_HOST}..."
      
      # Test connection and list workers
      buildctl debug workers
      
      echo "✅ Successfully connected to remote BuildKit daemon"

  - wait

  - label: ":docker: Build test image"
    plugins:
      - ecr#v3.3.0:
          login: true
          account-ids:
            - "097340723131"
          region: us-east-1
    command: |
      set -euo pipefail
      
      # Create a simple test Dockerfile
      cat > Dockerfile.test <<'EOF'
      FROM alpine:latest
      RUN echo "Built with remote BuildKit" > /test.txt
      CMD ["cat", "/test.txt"]
      EOF
      
      echo "Building test image with remote BuildKit..."
      
      buildctl build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        --opt filename=Dockerfile.test \
        --output type=registry,name=097340723131.dkr.ecr.us-east-1.amazonaws.com/namespace-sample:buildkit-test,push=true
      
      echo "✅ Successfully built and pushed image using remote BuildKit"
