steps:
  # Step 1: Build and test
  - label: ":hammer: Build Application"
    key: "build"
    command: |
      echo "Building application..."
      sleep 2
      echo "Build complete!"
      
  - label: ":test_tube: Run Tests"
    key: "test"
    depends_on: "build"
    command: |
      echo "Running tests..."
      sleep 3
      echo "Tests passed!"

  # Step 2: Decision point - using INPUT instead of BLOCK
  - input: ":thinking_face: Release Decision"
    key: "release-decision"
    depends_on: "test"
    fields:
      - select: "What would you like to do with this build?"
        key: "action"
        required: true
        options:
          - label: "Deploy to Production :rocket:"
            value: "deploy-prod"
          - label: "Deploy to Staging :test_tube:"
            value: "deploy-staging"  
          - label: "Abandon Release :x:"
            value: "abandon"
          - label: "Schedule for Later :clock1:"
            value: "schedule"
            
      - text: "Notes (optional)"
        key: "notes"
        required: false

  # Step 3: Upload release pipeline
  - label: ":pipeline: Execute Release Decision"
    depends_on: "release-decision"
    command: |
      echo "--- :mag: Getting release decision"
      ACTION=$(buildkite-agent meta-data get "action")
      NOTES=$(buildkite-agent meta-data get "notes" --default "No notes provided")
      
      echo "Decision: $ACTION"
      echo "Notes: $NOTES"
      
      if [ -z "$ACTION" ]; then
        echo "ERROR: Action is empty!"
        echo "Available metadata:"
        buildkite-agent meta-data list
        exit 1
      fi
      
      echo "--- :rocket: Uploading release pipeline"
      buildkite-agent pipeline upload release-pipeline.yml
